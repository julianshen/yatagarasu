# Yatagarasu Watermark Example
# Demonstrates text watermarking on images
#
# Usage:
#   docker compose up -d
#   # Public (no watermark):
#   curl "http://localhost:8080/public/nature.jpg?w=800" -o public.jpg
#   # Preview (watermarked):
#   curl "http://localhost:8080/preview/nature.jpg?w=800" -o preview.jpg
#
# Cleanup:
#   docker compose down -v

services:
  # MinIO S3-compatible storage
  minio:
    image: minio/minio:latest
    container_name: yatagarasu-watermark-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - yatagarasu-watermark

  # MinIO setup - creates buckets and uploads sample images
  minio-setup:
    image: curlimages/curl:latest
    container_name: yatagarasu-watermark-minio-setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo 'Setting up MinIO...'

        # Install mc
        wget -q https://dl.min.io/client/mc/release/linux-amd64/mc -O /tmp/mc
        chmod +x /tmp/mc
        /tmp/mc alias set myminio http://minio:9000 minioadmin minioadmin

        # Create buckets
        /tmp/mc mb --ignore-existing myminio/public-assets
        /tmp/mc mb --ignore-existing myminio/premium-assets
        /tmp/mc mb --ignore-existing myminio/documents
        /tmp/mc anonymous set public myminio/public-assets

        # Download sample images (JPEG)
        echo 'Downloading sample images...'
        curl -sL -o /tmp/nature.jpg 'https://picsum.photos/1920/1080' || true
        curl -sL -o /tmp/city.jpg 'https://picsum.photos/1600/900' || true

        # Download PNG images (from placehold.co which supports PNG)
        curl -sL -o /tmp/abstract.png 'https://placehold.co/1200x800/3498db/ffffff.png?text=Abstract' || true
        curl -sL -o /tmp/logo.png 'https://placehold.co/800x600/e74c3c/ffffff.png?text=Logo' || true

        # Create placeholder if downloads failed
        if [ ! -s /tmp/nature.jpg ]; then
          echo 'Creating placeholder images...'
          dd if=/dev/urandom bs=1K count=50 2>/dev/null | base64 > /tmp/nature.jpg
          dd if=/dev/urandom bs=1K count=40 2>/dev/null | base64 > /tmp/city.jpg
        fi

        # Upload JPEGs to buckets
        /tmp/mc cp /tmp/nature.jpg myminio/public-assets/nature.jpg
        /tmp/mc cp /tmp/city.jpg myminio/public-assets/city.jpg
        /tmp/mc cp /tmp/nature.jpg myminio/premium-assets/nature.jpg
        /tmp/mc cp /tmp/city.jpg myminio/premium-assets/city.jpg
        /tmp/mc cp /tmp/nature.jpg myminio/documents/report-cover.jpg

        # Upload PNGs to buckets
        /tmp/mc cp /tmp/abstract.png myminio/public-assets/abstract.png
        /tmp/mc cp /tmp/logo.png myminio/public-assets/logo.png
        /tmp/mc cp /tmp/abstract.png myminio/premium-assets/abstract.png
        /tmp/mc cp /tmp/logo.png myminio/premium-assets/logo.png

        echo 'MinIO setup complete!'
        /tmp/mc ls myminio/public-assets/
        /tmp/mc ls myminio/premium-assets/
    networks:
      - yatagarasu-watermark

  # Yatagarasu S3 Proxy with watermarking
  yatagarasu:
    image: ghcr.io/julianshen/yatagarasu:latest
    container_name: yatagarasu-watermark-proxy
    ports:
      - "8080:8080"
      - "9090:9090"
    environment:
      AWS_ACCESS_KEY: minioadmin
      AWS_SECRET_KEY: minioadmin
      JWT_SECRET: "super-secret-key-for-demo-only"
      RUST_LOG: info
    volumes:
      - ./config.yaml:/etc/yatagarasu/config.yaml:ro
    depends_on:
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - yatagarasu-watermark

networks:
  yatagarasu-watermark:
    driver: bridge
