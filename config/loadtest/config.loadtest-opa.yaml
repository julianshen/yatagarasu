# Load Test Configuration with OPA Authorization
#
# Prerequisites:
# 1. Start OPA server:
#    docker run -d -p 8181:8181 --name opa openpolicyagent/opa:latest run --server --addr=0.0.0.0:8181
#
# 2. Load the test policy:
#    curl -X PUT http://localhost:8181/v1/policies/authz \
#      -H "Content-Type: text/plain" \
#      --data-binary @policies/loadtest-authz.rego
#
# 3. Start MinIO (if not running):
#    docker run -d -p 9000:9000 --name minio \
#      -e MINIO_ROOT_USER=minioadmin \
#      -e MINIO_ROOT_PASSWORD=minioadmin \
#      minio/minio server /data
#
# 4. Start the proxy:
#    cargo run -- --config config.loadtest-opa.yaml
#
# 5. Run load tests:
#    k6 run k6-opa.js

server:
  address: "127.0.0.1"
  port: 8080

buckets:
  # Public bucket (no authentication, no OPA)
  - name: "public"
    path_prefix: "/test"
    s3:
      endpoint: "http://localhost:9000"
      region: "us-east-1"
      bucket: "test-public"
      access_key: "minioadmin"
      secret_key: "minioadmin"
    auth:
      enabled: false

  # OPA-protected bucket (JWT + OPA authorization)
  - name: "opa-protected"
    path_prefix: "/opa-protected"
    s3:
      endpoint: "http://localhost:9000"
      region: "us-east-1"
      bucket: "test-opa"
      access_key: "minioadmin"
      secret_key: "minioadmin"
    auth:
      enabled: true
      jwt:
        secret: "test-secret-key-for-load-testing-only"
        algorithm: "HS256"
        token_sources:
          - source_type: "header"
            name: "Authorization"
            prefix: "Bearer "
          - source_type: "query"
            name: "token"
        claims_verification: []
    # OPA Authorization
    authorization:
      type: opa
      url: "http://localhost:8181"
      policy_path: "yatagarasu/authz/allow"
      timeout_ms: 100          # Fast fail for load testing
      cache_ttl_seconds: 60    # Cache OPA decisions for 60s
      fail_mode: closed        # Deny on OPA failure

  # Private bucket (JWT only, no OPA - for comparison)
  - name: "private"
    path_prefix: "/private"
    s3:
      endpoint: "http://localhost:9000"
      region: "us-east-1"
      bucket: "test-private"
      access_key: "minioadmin"
      secret_key: "minioadmin"
    auth:
      enabled: true
      jwt:
        secret: "test-secret-key-for-load-testing-only"
        algorithm: "HS256"
        token_sources:
          - source_type: "header"
            name: "Authorization"
            prefix: "Bearer "
          - source_type: "query"
            name: "token"
        claims_verification: []

logging:
  level: "info"
  format: "json"

# Metrics endpoint for monitoring during load tests
metrics:
  enabled: true
  address: "127.0.0.1"
  port: 9090
